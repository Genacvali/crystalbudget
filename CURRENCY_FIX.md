# Исправление проблем с валютой

## Что было исправлено

### 1. Синхронизация валюты по умолчанию
- **Проблема**: Валюта хранилась только в `localStorage` и различалась в Safari/приложении/боте
- **Решение**: Валюта теперь синхронизируется с базой данных (`user_preferences`)

### 2. Валюта транзакций
- **Проблема**: При создании транзакций использовалась дефолтная валюта пользователя, а не валюта категории
- **Решение**: 
  - Веб-приложение: использует валюту из allocations категории
  - Telegram бот: использует валюту категории через `getCategoryCurrency()`

## Как это работает сейчас

### Приоритет валют при создании расхода:
1. **Валюта категории** (из allocations) — если у категории есть бюджет в определенной валюте
2. **Распознанная валюта** (из текста) — если пользователь написал "1000 драм"
3. **Валюта пользователя по умолчанию** (из настроек)

### Приоритет валют при создании дохода:
1. **Валюта источника** (пока не реализовано, заглушка)
2. **Валюта пользователя по умолчанию** (из настроек)

## Что нужно сделать пользователю

### 1. Установить правильную валюту по умолчанию
1. Откройте **Настройки** в приложении
2. Найдите раздел **"Валюта"**
3. Выберите вашу основную валюту (например, **AMD — Армянский драм**)
4. Валюта автоматически сохранится в БД и синхронизируется везде

### 2. Проверить валюты в категориях
1. Откройте **Категории**
2. Для каждой категории проверьте раздел **"Источники и распределение"**
3. Убедитесь, что в allocations указана правильная валюта
4. Если нужно, отредактируйте и выберите правильную валюту

### 3. Перезагрузить приложение/бота
- После изменения настроек перезагрузите страницу или откройте заново
- В Telegram боте отправьте `/start` для обновления

## Технические детали

### Файлы, которые были изменены:
1. `src/hooks/useCurrency.tsx` — добавлена синхронизация с БД
2. `src/pages/Settings.tsx` — добавлен выбор валюты
3. `supabase/functions/telegram-bot/index.ts` — добавлена функция `getCategoryCurrency()`
4. `src/components/ExpenseDialog.tsx` — улучшена логика выбора валюты

### Как проверить:
1. Зайдите в приложение через Safari
2. Создайте расход для категории "Еда" (с валютой AMD)
3. Транзакция должна создаться в AMD, а не в USD или RUB
4. В Telegram боте также должна использоваться валюта категории

## Примечания

- Если у категории **несколько валют** в allocations, приложение предложит выбрать валюту
- Валюта транзакции сохраняется в поле `currency` в таблице `expenses`/`incomes`
- Старые транзакции остаются с той валютой, в которой были созданы

